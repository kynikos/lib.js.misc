'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

// Generated by CoffeeScript 2.5.1
// lib.cs.misc - Check the status of code repositories under a root directory.
// Copyright (C) 2016 Dario Giovannetti <dev@dariogiovannetti.net>

// This file is part of lib.cs.misc.

// lib.cs.misc is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.

// lib.cs.misc is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.

// You should have received a copy of the GNU General Public License
// along with lib.cs.misc.  If not, see <http://www.gnu.org/licenses/>.
var $, EnhancedHeading;

$ = require('jquery');

module.exports.TableOfContents = function () {
  function TableOfContents() {
    _classCallCheck(this, TableOfContents);

    // TODO: This class won't work well if a document's first heading after
    //       the #table-of-contents is e.g. a <h3> and then there are <h2>
    //       elements further down; in other words, the first header element
    //       after #table-of-contents must be the lowest header level that
    //       should be in the table of contents
    this.rootul = $('<ul>');
    this.refresh();
    $('#table-of-contents').after(this.rootul);
  }

  _createClass(TableOfContents, [{
    key: 'refresh',
    value: function refresh() {
      var currhlevel, currul, tocheaderfound;
      this.rootul.empty();
      tocheaderfound = false;
      currul = this.rootul;
      currhlevel = 0;
      return $(':header').each(function () {
        var N, header, hlevel, i, link, ref;
        header = $(this);
        if (tocheaderfound) {
          header.addClass('toc-heading');
          hlevel = header.prop('tagName').slice(1);
          if (currul.children().length > 0 && hlevel > currhlevel) {
            currul = $('<ul>').appendTo(currul);
          } else if (hlevel < currhlevel) {
            for (N = i = 0, ref = currhlevel - hlevel; 0 <= ref ? i < ref : i > ref; N = 0 <= ref ? ++i : --i) {
              currul = currul.parent();
            }
          }
          currhlevel = hlevel;
          link = $('<a>').attr('href', '#' + header.attr('id')).text(header.text());
          return $('<li>').append(link).appendTo(currul);
        } else if (header.attr('id') === 'table-of-contents') {
          return tocheaderfound = true;
        }
      });
    }
  }]);

  return TableOfContents;
}();

EnhancedHeading = function () {
  var _collapse_section, _expand_section, hide_actions, show_actions;

  var EnhancedHeading = function EnhancedHeading(section) {
    _classCallCheck(this, EnhancedHeading);

    var header;
    this.section = section;
    header = this.section.find(':header').first();
    header.wrap($('<div>').addClass('section-start').mouseenter(show_actions).mouseleave(hide_actions));
    header.css('display', 'inline-block').after($('<span>').addClass('actions').append($('<a>').css('margin-left', '4px').attr('href', '#' + header.attr('id')).text('Â¶')).append($('<a>').css('margin-left', '4px').attr('href', '#').text('top')).append($('<a>').css('margin-left', '4px').attr('href', '#').text('collapse').click(_collapse_section)).hide());
  };

  ;

  show_actions = function show_actions(event) {
    return $(this).children('span.actions').show();
  };

  hide_actions = function hide_actions(event) {
    return $(this).children('span.actions').hide();
  };

  _collapse_section = function collapse_section(event) {
    $(this).closest('div.section-start').nextAll().hide();
    $(this).text('expand').off('click', _collapse_section).on('click', _expand_section);
    return false;
  };

  _expand_section = function expand_section(event) {
    $(this).closest('div.section-start').nextAll().show();
    $(this).text('collapse').off('click', _expand_section).on('click', _collapse_section);
    return false;
  };

  return EnhancedHeading;
}.call(undefined);

module.exports.extjQuery = function ($) {
  return $.fn.enhanceHeading = function () {
    return this.each(function () {
      new EnhancedHeading($(this));
      return $(this);
    });
  };
};